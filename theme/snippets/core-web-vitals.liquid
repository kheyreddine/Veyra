{% comment %}
  Core Web Vitals Optimization Snippet
  - Prevents Cumulative Layout Shift (CLS) with proper sizing
  - Optimizes Largest Contentful Paint (LCP) with critical resources
  - Improves First Input Delay (FID) with non-blocking interactions
  
  Business Problem Solved: Poor Core Web Vitals scores hurt search rankings
  and user experience. This implementation ensures all metrics stay in the
  "Good" range for better SEO and user satisfaction.
  
  Usage: {% render 'core-web-vitals', type: 'image', data: image_data %}
{% endcomment %}

{% assign type = type | default: 'general' %}
{% assign data = data | default: nil %}

{% case type %}
  {% when 'image' %}
    {% comment %} Image CLS prevention with aspect ratio containers {% endcomment %}
    {% if data %}
      {% assign aspect_ratio = data.aspect_ratio | default: '16/9' %}
      {% assign width = data.width | default: 400 %}
      {% assign height = data.height | default: 225 %}
      
      <div class="core-web-vitals__image-container" style="aspect-ratio: {{ aspect_ratio }}; width: {{ width }}px; height: {{ height }}px;">
        {% if data.src %}
          <img
            src="{{ data.src }}"
            alt="{{ data.alt | escape }}"
            class="core-web-vitals__image"
            width="{{ width }}"
            height="{{ height }}"
            loading="{{ data.loading | default: 'lazy' }}"
            style="width: 100%; height: 100%; object-fit: cover;">
        {% else %}
          <div class="core-web-vitals__image-placeholder" style="width: 100%; height: 100%; background-color: var(--color-gray-light); display: flex; align-items: center; justify-content: center;">
            <span>Loading...</span>
          </div>
        {% endif %}
      </div>
    {% endif %}

  {% when 'font' %}
    {% comment %} Font CLS prevention with font-display: swap {% endcomment %}
    <style>
      @font-face {
        font-family: '{{ data.family | default: "Inter" }}';
        font-style: {{ data.style | default: "normal" }};
        font-weight: {{ data.weight | default: "400" }};
        font-display: swap;
        src: url('{{ data.src }}') format('{{ data.format | default: "woff2" }}');
      }
      
      .core-web-vitals__font-loaded {
        font-family: '{{ data.family | default: "Inter" }}', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
    </style>

  {% when 'skeleton' %}
    {% comment %} Loading skeleton to prevent layout shift {% endcomment %}
    <div class="core-web-vitals__skeleton" style="width: {{ data.width | default: '100%' }}; height: {{ data.height | default: '200px' }}; background: linear-gradient(90deg, var(--color-gray-light) 25%, var(--color-gray-medium) 50%, var(--color-gray-light) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
      <span class="sr-only">Loading...</span>
    </div>

  {% when 'container' %}
    {% comment %} Container with stable dimensions to prevent CLS {% endcomment %}
    <div class="core-web-vitals__container" style="min-height: {{ data.min_height | default: 'auto' }}; width: {{ data.width | default: '100%' }};">
      {{ data.content }}
    </div>

  {% when 'button' %}
    {% comment %} Button with stable dimensions and hover states {% endcomment %}
    <button
      class="core-web-vitals__button"
      type="{{ data.type | default: 'button' }}"
      style="min-width: {{ data.min_width | default: '120px' }}; height: {{ data.height | default: '44px' }}; padding: {{ data.padding | default: '12px 24px' }}; border: none; border-radius: {{ data.border_radius | default: '25px' }}; background-color: {{ data.background | default: 'var(--color-primary)' }}; color: {{ data.color | default: 'var(--color-white)' }}; font-size: {{ data.font_size | default: '16px' }}; font-weight: {{ data.font_weight | default: '500' }}; cursor: pointer; transition: all 0.3s ease-in-out; will-change: transform; transform: translateZ(0);"
      {% if data.disabled %}disabled{% endif %}>
      {{ data.text | default: 'Button' }}
    </button>

  {% when 'grid' %}
    {% comment %} CSS Grid with stable dimensions to prevent CLS {% endcomment %}
    <div class="core-web-vitals__grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax({{ data.min_width | default: '300px' }}, 1fr)); gap: {{ data.gap | default: '20px' }}; width: 100%;">
      {% for item in data.items %}
        <div class="core-web-vitals__grid-item" style="min-height: {{ data.item_height | default: '200px' }}; background-color: var(--color-white); border: 1px solid var(--color-gray-light); border-radius: var(--border-radius-md); padding: {{ data.item_padding | default: '20px' }};">
          {{ item }}
        </div>
      {% endfor %}
    </div>

  {% when 'text' %}
    {% comment %} Text with stable line height to prevent CLS {% endcomment %}
    <div class="core-web-vitals__text" style="line-height: {{ data.line_height | default: '1.5' }}; min-height: {{ data.min_height | default: 'auto' }};">
      {{ data.content }}
    </div>

  {% else %}
    {% comment %} General CLS prevention utilities {% endcomment %}
    <style>
      /* Prevent layout shift with stable dimensions */
      .core-web-vitals__stable {
        contain: layout style paint;
        will-change: transform;
        transform: translateZ(0);
      }
      
      /* Prevent image layout shift */
      .core-web-vitals__image-stable {
        aspect-ratio: attr(width) / attr(height);
        width: 100%;
        height: auto;
      }
      
      /* Prevent text layout shift */
      .core-web-vitals__text-stable {
        min-height: 1.2em;
        line-height: 1.2;
      }
      
      /* Prevent button layout shift */
      .core-web-vitals__button-stable {
        min-width: 120px;
        height: 44px;
        padding: 12px 24px;
      }
      
      /* Loading skeleton animation */
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      
      /* Focus states for accessibility */
      .core-web-vitals__focusable:focus {
        outline: 2px solid var(--color-accent);
        outline-offset: 2px;
      }
      
      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        .core-web-vitals__animated {
          animation: none;
          transition: none;
        }
      }
    </style>
{% endcase %}

{% comment %}
  Additional Core Web Vitals optimizations
  - Use data attributes for dynamic content to prevent CLS
  - Implement proper loading states for all interactive elements
  - Ensure stable dimensions for all components
  - Use CSS containment for better performance
{% endcomment %}
